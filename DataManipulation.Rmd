---
title: "GetData"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(rvest)
library(XML)
library(RCurl)
library(tidyverse)
library(readr)
library(xgboost)
```


```{r getData, eval=FALSE}
results <- read.csv("Big_Dance_CSV.csv")
results <- subset(results, select = -Winner )

all_data <- read.csv("all_data.csv")
all_data <- all_data %>%
  mutate(higher_score = score, lower_score = score.1)
all_data <- subset(all_data, select = -score.1)

matchups <- read.csv("FirstRound2021.csv")

kenPomData <- data.frame()
inputPath <- "2019Data\\" # Location for storing the data to be used as an input to the ML work.

# For training purposes, get all data before the current year. Aggregate into a single data frame.

getKenPomYearData <- function(year)
{
    theUrl <- paste0("https://kenpom.com/index.php?y=", as.character(year))
    page <- read_html(theUrl)
    tables <- page %>% html_nodes("table") %>% html_table()
    data <- as.data.frame(tables[1])

    colnames(data) <- c("Rk", "Team", "Conf", "Record", "AdjEM", "AdjO", 
         "AdjO_R", "AdjD", "AdjD_R", "AdjT", "AdjT_R",
         "Luck", "Luck_R", "SoS_AdjEM", "SoS_AdjEM_R", 
         "OppO", "OppO_R", "OppD", "OppD_R", "NC_AdjEM", "NC_AdjEM_R")
    
    data$Year = year

    return(data)
}

for (year in 2002:2021)
{
    kenPomYear <- getKenPomYearData(year)
    kenPomData <- rbind(kenPomData, kenPomYear)
}

names(kenPomData)<-tolower(names(kenPomData))
names(results)<-tolower(names(results))
```

```{r cleaning, eval=FALSE}
kenPomData <- kenPomData %>%
  filter(rk != "Rk") %>%
  filter(!is.na(rk)) %>%
  filter(rk != "")

kenPomData2021 <- kenPomData2021 %>%
  filter(rk != "Rk") %>%
  filter(!is.na(rk)) %>%
  filter(rk != "")

kenPomData <- kenPomData %>%
  mutate(team = gsub("[.]", "", team))

kenPomData$team <- gsub('[0-9]+', '', kenPomData2021$team)
kenPomData$team <- trimws(kenPomData$team, "r")

kenPomData2021 <- kenPomData2021 %>%
  mutate(team = gsub("[.]", "", team))

kenPomData2021$team <- gsub('[0-9]+', '', kenPomData2021$team)
kenPomData2021$team <- trimws(kenPomData2021$team, "r")

kenPomData2021 <- kenPomData2021 %>% 
  select(team, adjo, adjd, adjt) %>%
  mutate(adjo = as.numeric(adjo), adjd = as.numeric
         (adjd), adjt = as.numeric(adjt))

kenPomData <- subset(kenPomData, select = -c(conf, nc_adjem, nc_adjem_r, sos_adjem, sos_adjem_r, oppo, oppo_r, oppd, oppd_r))

matchups <- matchups %>%
  mutate(higherseed = gsub("[.]", "", higherseed), lowerseed = gsub("[.]", "", lowerseed)) %>%
  mutate(lowerseed = if_else(lowerseed == "Norfolk/Appalachian", "Norfolk St", lowerseed)) %>%
  mutate(lowerseed = if_else(lowerseed == "MSM/TexasSouthern", "Texas Southern", lowerseed)) %>%
  mutate(lowerseed = if_else(lowerseed == "Wichita/Drake", "Drake", lowerseed)) %>%
  mutate(lowerseed = if_else(lowerseed == "Michian/UCLA", "UCLA", lowerseed)) %>%
  mutate(lowerseed = if_else(lowerseed == "Eastern Wash", "Eastern Washington", lowerseed))
  
```

```{r joinData, eval=FALSE}

real_data <- merge(results, kenPomData, by.x = c("year", "higherteam"), by.y = c("year", "team"))

matchups <- merge(matchups, kenPomData2021, by.x = "lowerseed", by.y = "team")

all_data <- merge(all_data, kenPomData, by = c("year", "team"))

all_data <- all_data %>%
  rename(lowerteam = team)

kenPomData %>% group_by(team) %>% count()
results %>% group_by(team) %>% count()

all_data <- all_data %>%
  mutate(winner = if_else(higher_score > lower_score, "1", "0")) %>%
  mutate(winner = factor(winner))

write.csv(all_data,"all_data.csv", row.names = TRUE)

col_order <- c("round", "higherseed", "lowerseed", "higher_score", "lower_score", "higherteam", "lowerteam", "rk.x", "adjem.x", "adjo.x", "adjo_r.x", "adjd.x", "adjd_r.x", "adjt.x", "adjt_r.x", "luck.x", "luck_r.x", "rk.y", "adjem.y", "adjo.y", "adjo_r.y", "adjd.y", "adjd_r.y", "adjt.y", "adjt_r.y", "year")

all_data <- all_data[, col_order]

glm1 <- glm(winner ~ adjo.x + adjd.x + adjo.y + adjd.y + adjt.y + adjt.x, data = all_data, family = binomial)

most_data <- all_data %>% filter(year != 2019)
data2019 <- all_data %>% filter(year == 2019)

glm2 <- glm(winner ~ adjo.x + adjd.x + adjo.y + adjd.y + adjt.y + adjt.x, data = all_data, family = binomial)
tidy(glm2)

lm_higher_score <- lm(higher_score ~ adjo.x + adjd.y + adjt.x + adjt.y, data = most_data)
tidy(lm_higher_score)

lm_lower_score <- lm(lower_score ~ adjo.y + adjd.x + adjt.y + adjt.x, data = most_data)
tidy(lm_lower_score)

predicted_scores <- data.frame()
predicted_scores <- predicted_scores %>%
  mutate(seed1 = "", seed2 = "", higherteam = "", lowerteam = "", higher_score = 0, lower_score = 0, predicted_higher_score = 0, predicted_lower_score = 0)

for(x in data2019$higherteam){
  temp <- data2019 %>%
    filter(higherteam == x)
  seed1 = temp$higherseed
  seed2 = temp$lowerseed
  higher_team = temp$higherteam
  lower_team = temp$lowerteam
  higher_score = temp$higher_score
  lower_score = temp$lower_score
  predicted_high = predict(lm_higher_score, temp)
  predicted_low = predict(lm_lower_score, temp)
  
  df<-data.frame(seed1, seed2, higher_team, lower_team, higher_score, lower_score, predicted_high, predicted_low)
  predicted_scores <- rbind(predicted_scores, df)
}

predicted_scores <- predicted_scores %>%
  mutate(real_diff = higher_score - lower_score, pred_diff = predicted_high - predicted_low)

predicted_scores <- predicted_scores %>%
  mutate(correct = if_else((real_diff < 0 & pred_diff < 0) |  (real_diff > 0 & pred_diff > 0), TRUE, FALSE))

predicted_scores <- predicted_scores %>% unique()



predicted_scores <- data.frame()
predicted_scores <- predicted_scores %>%
  mutate(seed1 = "", seed2 = "", higherteam = "", lowerteam = "", winner = factor(0), pred_winner = 0)

for(x in all_data$higherteam){
  temp <- all_data %>%
    filter(higherteam == x)
  seed1 = temp$higherseed
  seed2 = temp$lowerseed
  higher_team = temp$higherteam
  lower_team = temp$lowerteam
  winner = temp$winner
  pred_winner= predict(glm2, temp)
  
  df<-data.frame(seed1, seed2, higher_team, lower_team, winner, pred_winner)
  predicted_scores <- rbind(predicted_scores, df)
}

predicted_scores <- predicted_scores %>%
  mutate(pred_winner = if_else(pred_winner < 0.1, 0, 1)) %>%
  mutate(pred_winner = factor(pred_winner)) %>%
  mutate(correct = if_else(pred_winner == winner, TRUE, FALSE))

predicted_scores <- predicted_scores %>% unique()

predicted_scores %>% count(correct)
```

```{r for2021, eval=FALSE}
predicted_scores2 <- data.frame()
predicted_scores2 <- predicted_scores2 %>%
  mutate(higherteam = "", lowerteam = "", pred_winner = 0)

for(x in new_data$higherseed){
  temp <- new_data %>%
    filter(higherseed == x)
  higher_team = temp$higherseed
  lower_team = temp$lowerseed
  pred_winner = predict(glm1, temp)
  df<-data.frame(higher_team, lower_team, pred_winner)
  predicted_scores2 <- rbind(predicted_scores2, df)
}
 
predicted_scores2 <- predicted_scores2 %>%
  mutate(pred_winner = if_else(pred_winner < 0.1, 0, 1)) %>%
  mutate(pred_winner = factor(pred_winner))

predicted_scores2 <- predicted_scores2 %>% unique()
```

```{r xgboost, eval=FALSE}
set.seed(33)

most_data <- most_data %>%
  mutate(diff_score = higher_score - lower_score)

model_data <- all_data %>%
  mutate(diff_score = as.numeric(diff_score)) %>%
  select(diff_score, adjo.x, adjd.x, adjt.x, adjo.y, adjd.y, adjt.y)
model_data <- model_data[sample(1:nrow(model_data)), ]

labels <- model_data %>%
  select(diff_score)

model_data <- model_data %>%
  select(-diff_score)

final <- data.matrix(model_data)

numberOfTrainingSamples <- round(length(labels$diff_score) * 1)

train_data <- final[1:numberOfTrainingSamples,]
train_labels <- labels[1:numberOfTrainingSamples,]

test_data <- final[-(1:numberOfTrainingSamples),]
test_labels <- labels[-(1:numberOfTrainingSamples),]

dtrain <- xgb.DMatrix(data = train_data, label= train_labels)
dtest <- xgb.DMatrix(data = test_data, label= test_labels)

xgb <- xgboost(data = dtrain,  
                 nround = 20)

pred <- predict(xgb, dtest)

err <- median(pred - test_labels)
print(paste("test-error=", err))

importance_matrix <- xgb.importance(names(final), model = xgb)

# and plot it!
xgb.plot.importance(importance_matrix)

test_labels <- data.frame(test_labels)
test_labels <- test_labels %>%
  mutate(pred_diff = predict(xgb, dtest)) %>%
  mutate(correct = if_else((test_labels > 0 & pred_diff > 0) | (test_labels < 0 & pred_diff < 0), TRUE, FALSE)) %>% 
  mutate(residual = test_labels - pred_diff)

median(test_labels$residual)


new_model_data <- matchups %>%
  select(adjo.x, adjd.x, adjt.x, adjo.y, adjd.y, adjt.y)

test_data2019 <- data2019 %>%
  select(adjo.x, adjd.x, adjt.x, adjo.y, adjd.y, adjt.y)
test_data2019_matrix <- as.matrix(test_data2019)

dtest <- xgb.DMatrix(data = test_data2019_matrix)

new_data2 <- test_data2019 %>%
  mutate(pred_diff = data.frame(predict(xgb, dtest))) %>% unique()

matchups_with_pred <- data2019 %>%
  mutate(pred_diff = new_data2$pred_diff)

matchups_with_pred <- matchups_with_pred %>%
  mutate(score_diff = higher_score - lower_score) %>%
  mutate(correct = if_else((score_diff > 0 & pred_diff > 0) | (score_diff < 0 & pred_diff < 0), TRUE, FALSE)) %>%
  mutate(residual = score_diff - pred_diff)
         
matchups_with_pred %>% count(correct)
matchups_with_pred %>% mean(residual.predict.xgb..dtest.)


write.csv(matchups_with_pred,"matchups_with_pred.csv", row.names = TRUE)

matchups_with_pred1 <- matchups_with_pred[-nrow(matchups_with_pred),]


test_data2021 <- as.matrix(new_model_data)

dtest <- xgb.DMatrix(data = test_data2021)

new_data2 <- new_model_data %>%
  mutate(pred_diff = data.frame(predict(xgb, dtest))) %>% unique()

matchups_with_pred <- matchups %>%
  mutate(pred_diff = new_data2$pred_diff)



mich = c(107.5, 93.8, 68.6, 114.2, 97.9, 64.6)
norfolk = c(99.5, 103.2, 67.6, 98.4, 102.8, 65.7)
texsouth = c(99.3, 104.4, 71.7, 94.7, 100.8, 61.9)
drake = c(109.0, 97.2, 67.3, 112.8, 98.3, 66.6)

today <- data.frame(rbind(mich, norfolk, texsouth, drake)) %>%
  rename(adjo.x = X1, adjd.x = X2, adjt.x = X3, adjo.y = X4, adjd.y = X5, adjt.y = X6)

dtest <- xgb.DMatrix(data = as.matrix(today))

today_test <- data.frame(predict(xgb, dtest)) %>% unique()

matchups_with_pred <- matchups %>%
  mutate(pred_diff = new_data2$pred_diff)
```


