---
title: "GetData"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(rvest)
library(XML)
library(RCurl)
library(tidyverse)
library(readr)
```


```{r getData, eval=FALSE}
results <- read.csv("Big_Dance_CSV.csv")
results <- subset(results, select = -Winner )

matchups <- read.csv("FirstRound2021.csv")

kenPomData <- data.frame()
inputPath <- "2019Data\\" # Location for storing the data to be used as an input to the ML work.

# For training purposes, get all data before the current year. Aggregate into a single data frame.

getKenPomYearData <- function(year)
{
    theUrl <- paste0("https://kenpom.com/index.php?y=", as.character(year))
    page <- read_html(theUrl)
    tables <- page %>% html_nodes("table") %>% html_table()
    data <- as.data.frame(tables[1])

    colnames(data) <- c("Rk", "Team", "Conf", "Record", "AdjEM", "AdjO", 
         "AdjO_R", "AdjD", "AdjD_R", "AdjT", "AdjT_R",
         "Luck", "Luck_R", "SoS_AdjEM", "SoS_AdjEM_R", 
         "OppO", "OppO_R", "OppD", "OppD_R", "NC_AdjEM", "NC_AdjEM_R")
    
    data$Year = year

    return(data)
}

for (year in 2002:2019)
{
    kenPomYear <- getKenPomYearData(year)
    kenPomData <- rbind(kenPomData, kenPomYear)
}

kenPomData2021 <- getKenPomYearData(2021)

names(kenPomData)<-tolower(names(kenPomData))
names(kenPomData2021)<-tolower(names(kenPomData2021))
names(results)<-tolower(names(results))
```

```{r cleaning, eval=FALSE}
kenPomData <- kenPomData %>%
  filter(rk != "Rk") %>%
  filter(!is.na(rk)) %>%
  filter(rk != "")

kenPomData2021 <- kenPomData2021 %>%
  filter(rk != "Rk") %>%
  filter(!is.na(rk)) %>%
  filter(rk != "")

kenPomData <- kenPomData %>%
  mutate(team = gsub("[.]", "", team))

kenPomData2021 <- kenPomData2021 %>%
  mutate(team = gsub("[.]", "", team))

kenPomData2021 <- kenPomData2021 %>%
  mutate(seed = parse_number(team)) %>%
  filter(!is.na(seed))

kenPomData$team <- gsub('[0-9]+', '', kenPomData$team)
kenPomData$team <- trimws(kenPomData$team, "r")

kenPomData2021$team <- gsub('[0-9]+', '', kenPomData2021$team)
kenPomData2021$team <- trimws(kenPomData2021$team, "r")

results <- results %>%
  rename(team = lowerteam)

kenPomData <- subset(kenPomData, select = -c(conf, nc_adjem, nc_adjem_r, sos_adjem, sos_adjem_r, oppo, oppo_r, oppd, oppd_r))

kenPomData2021 <- subset(kenPomData2021, select = -c(conf, nc_adjem, nc_adjem_r, sos_adjem, sos_adjem_r, oppo, oppo_r, oppd, oppd_r))

kenPomData2021 %>%
  filter(team == "Wisconsin" | team == "North Carolina")
```

```{r joinData, eval=FALSE}

real_data <- merge(real_data, kenPomData, by.x = c("year", "lowerteam"), by.y = c("year", "team"))

all_data <- merge(all_data, kenPomData, by = c("year", "team"))

all_data <- all_data %>%
  rename(lowerteam = team)

kenPomData %>% group_by(team) %>% count()
results %>% group_by(team) %>% count()

write.csv(real_data,"all_data.csv", row.names = TRUE)

col_order <- c("round", "higherseed", "lowerseed", "higher_score", "lower_score", "higherteam", "lowerteam",  "winner", "rk.x", "record.x", "adjem.x", "adjo.x", "adjo_r.x", "adjd.x", "adjd_r.x", "adjt.x", "adjt_r.x", "luck.x", "luck_r.x", "rk.y", "record.y", "adjem.y", "adjo.y", "adjo_r.y", "adjd.y", "adjd_r.y", "adjt.y", "adjt_r.y", "luck.y", "luck_r.y",  "year")

all_data <- all_data %>%
  mutate(round = as.numeric(round), higherseed = as.numeric(higherseed), lowerseed = as.numeric(lowerseed))

cols_to_numeric <- c("rk.x", "adjem.x", "adjo.x", "adjo_r.x", "adjd.x", "adjd_r.x", "adjt.x", "adjt_r.x", "luck_r.x", "rk.y", "adjem.y", "adjo.y", "adjo_r.y", "adjd.y", "adjd_r.y", "adjt.y", "adjt_r.y", "luck_r.y")

for(x in cols_to_numeric){
  real_data[[x]] <- as.numeric(real_data[[x]])
}

make_numeric(cols_to_numeric)

real_data <- real_data %>%
  rename(higher_score = score, lower_score = score.1)

lm_higher_score_main <- lm(higher_score ~ adjo_r.x + adjd_r.y + adjt_r.x + adjt_r.y, data = real_data)
tidy(lm_higher_score)

lm_lower_score_main <- lm(lower_score ~ adjo_r.y + adjd_r.x + adjt_r.y + adjt_r.x, data = real_data)
tidy(lm_lower_score)

new_data <- merge(new_data, kenPomData2021, by.y = "team", by.x = "lowerseed")

most_data <- real_data %>% filter(year != 2018)
data2019 <- real_data %>% filter(year == 2018)

lm_higher_score <- lm(higher_score ~ adjo_r.x + adjd_r.y + adjt_r.x + adjt_r.y, data = most_data)
tidy(lm_higher_score)

lm_lower_score <- lm(lower_score ~ adjo_r.y + adjd_r.x + adjt_r.y + adjt_r.x, data = most_data)
tidy(lm_lower_score)

predicted_scores <- data.frame()
predicted_scores <- predicted_scores %>%
  mutate(seed1 = "", seed2 = "", higherteam = "", lowerteam = "", higher_score = 0, lower_score = 0, predicted_higher_score = 0, predicted_lower_score = 0)

for(x in data2019$higherteam){
  temp <- data2019 %>%
    filter(higherteam == x)
  seed1 = temp$higherseed
  seed2 = temp$lowerseed
  higher_team = temp$higherteam
  lower_team = temp$lowerteam
  higher_score = temp$higher_score
  lower_score = temp$lower_score
  predicted_high = predict(lm_higher_score, temp)
  predicted_low = predict(lm_lower_score, temp)
  
  df<-data.frame(seed1, seed2, higher_team, lower_team, higher_score, lower_score, predicted_high, predicted_low)
  predicted_scores <- rbind(predicted_scores, df)
}

predicted_scores <- predicted_scores %>%
  mutate(real_diff = higher_score - lower_score, pred_diff = predicted_high - predicted_low)

predicted_scores <- predicted_scores %>%
  mutate(correct = if_else((real_diff < 0 & pred_diff < 0) |  (real_diff > 0 & pred_diff > 0), TRUE, FALSE))

predicted_scores <- predicted_scores %>% unique()

predicted_scores %>% count(correct)
```

```{r for2021, eval=FALSE}
predicted_scores2 <- data.frame()
predicted_scores2 <- predicted_scores2 %>%
  mutate(higherteam = "", lowerteam = "", predicted_higher_score = 0, predicted_lower_score = 0)

for(x in new_data$higherseed){
  temp <- new_data %>%
    filter(higherseed == x)
  higher_team = temp$higherseed
  lower_team = temp$lowerseed
  predicted_high = predict(lm_higher_score_main, temp)
  predicted_low = predict(lm_lower_score_main, temp)
  
  df<-data.frame(higher_team, lower_team, predicted_high, predicted_low)
  predicted_scores2 <- rbind(predicted_scores2, df)
}

predicted_scores2 <- predicted_scores2 %>%
  mutate(pred_diff = predicted_high - predicted_low)

predicted_scores2 <- predicted_scores2 %>% unique()
```




